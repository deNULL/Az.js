"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Tokens=void 0;const az_1=require("./az");let TLDs="ac|ad|ae|aero|af|ag|ai|al|am|ao|aq|ar|arpa|as|asia|at|au|aw|ax|az|ba|bb|be|bf|bg|bh|bi|biz|bj|bm|bo|br|bs|bt|bv|bw|by|bz|ca|cat|cc|cd|cf|cg|ch|ci|cl|cm|cn|co|com|coop|cr|cu|cv|cw|cx|cz|de|dj|dk|dm|do|dz|ec|edu|ee|eg|es|et|eu|fi|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gov|gp|gq|gr|gs|gt|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|info|int|io|iq|ir|is|it|je|jo|jobs|jp|kg|ki|km|kn|kp|kr|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mg|mh|mil|mk|ml|mn|mo|mobi|mp|mq|mr|ms|mt|mu|museum|mv|mw|mx|my|na|name|nc|ne|net|nf|ng|nl|no|nr|nu|nz|om|org|pa|pe|pf|ph|pk|pl|pm|pn|post|pr|pro|ps|pt|pw|py|qa|re|ro|rs|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|st|su|sv|sx|sy|sz|tc|td|tel|tf|tg|th|tj|tk|tl|tm|tn|to|tr|travel|tt|tv|tw|tz|ua|ug|uk|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|yt|امارات|հայ|বাংলা|бел|中国|中國|الجزائر|مصر|ею|გე|ελ|香港|भारत|بھارت|భారత్|ભારત|ਭਾਰਤ|ভারত|இந்தியா|ایران|ايران|عراق|الاردن|한국|қаз|ලංකා|இலங்கை|المغرب|мкд|мон|澳門|澳门|مليسيا|عمان|پاکستان|پاكستان|فلسطين|срб|рф|قطر|السعودية|السعودیة|السعودیۃ|السعوديه|سودان|新加坡|சிங்கப்பூர்|سورية|سوريا|ไทย|تونس|台灣|台湾|臺灣|укр|اليمن|xxx|zm|aaa|aarp|abarth|abb|abbott|abbvie|abc|able|abogado|abudhabi|academy|accenture|accountant|accountants|aco|active|actor|adac|ads|adult|aeg|aetna|afamilycompany|afl|africa|africamagic|agakhan|agency|aig|aigo|airbus|airforce|airtel|akdn|alfaromeo|alibaba|alipay|allfinanz|allstate|ally|alsace|alstom|americanexpress|americanfamily|amex|amfam|amica|amsterdam|analytics|android|anquan|anz|aol|apartments|app|apple|aquarelle|arab|aramco|archi|army|art|arte|asda|associates|athleta|attorney|auction|audi|audible|audio|auspost|author|auto|autos|avianca|aws|axa|azure|baby|baidu|banamex|bananarepublic|band|bank|bar|barcelona|barclaycard|barclays|barefoot|bargains|baseball|basketball|bauhaus|bayern|bbc|bbt|bbva|bcg|bcn|beats|beauty|beer|bentley|berlin|best|bestbuy|bet|bharti|bible|bid|bike|bing|bingo|bio|black|blackfriday|blanco|blockbuster|blog|bloomberg|blue|bms|bmw|bnl|bnpparibas|boats|boehringer|bofa|bom|bond|boo|book|booking|boots|bosch|bostik|boston|bot|boutique|box|bradesco|bridgestone|broadway|broker|brother|brussels|budapest|bugatti|build|builders|business|buy|buzz|bzh|cab|cafe|cal|call|calvinklein|camera|camp|cancerresearch|canon|capetown|capital|capitalone|car|caravan|cards|care|career|careers|cars|cartier|casa|case|caseih|cash|casino|catering|catholic|cba|cbn|cbre|cbs|ceb|center|ceo|cern|cfa|cfd|chanel|channel|chase|chat|cheap|chintai|chloe|christmas|chrome|chrysler|church|cipriani|circle|cisco|citadel|citi|citic|city|cityeats|claims|cleaning|click|clinic|clinique|clothing|cloud|club|clubmed|coach|codes|coffee|college|cologne|comcast|commbank|community|company|compare|computer|comsec|condos|construction|consulting|contact|contractors|cooking|cookingchannel|cool|corsica|country|coupon|coupons|courses|credit|creditcard|creditunion|cricket|crown|crs|cruise|cruises|csc|cuisinella|cymru|cyou|dabur|dad|dance|date|dating|datsun|day|dclk|dds|deal|dealer|deals|degree|delivery|dell|deloitte|delta|democrat|dental|dentist|desi|design|dev|dhl|diamonds|diet|digital|direct|directory|discount|discover|dish|diy|dnp|docs|dodge|dog|doha|domains|dot|download|drive|dstv|dtv|dubai|duck|dunlop|duns|dupont|durban|dvag|dwg|earth|eat|edeka|education|email|emerck|emerson|energy|engineer|engineering|enterprises|epost|epson|equipment|ericsson|erni|esq|estate|esurance|etisalat|eurovision|eus|events|everbank|exchange|expert|exposed|express|extraspace|fage|fail|fairwinds|faith|family|fan|fans|farm|farmers|fashion|fast|fedex|feedback|ferrari|ferrero|fiat|fidelity|fido|film|final|finance|financial|fire|firestone|firmdale|fish|fishing|fit|fitness|flickr|flights|flir|florist|flowers|flsmidth|fly|foo|foodnetwork|football|ford|forex|forsale|forum|foundation|fox|free|fresenius|frl|frogans|frontdoor|frontier|ftr|fujitsu|fujixerox|fun|fund|furniture|futbol|fyi|gal|gallery|gallo|gallup|game|games|gap|garden|gbiz|gdn|gea|gent|genting|george|ggee|gift|gifts|gives|giving|glade|glass|gle|global|globo|gmail|gmbh|gmo|gmx|godaddy|gold|goldpoint|golf|goo|goodhands|goodyear|goog|google|gop|got|gotv|grainger|graphics|gratis|green|gripe|group|guardian|gucci|guge|guide|guitars|guru|hair|hamburg|hangout|haus|hbo|hdfc|hdfcbank|health|healthcare|help|helsinki|here|hermes|hgtv|hiphop|hisamitsu|hitachi|hiv|hkt|hockey|holdings|holiday|homedepot|homegoods|homes|homesense|honda|honeywell|horse|host|hosting|hot|hoteles|hotmail|house|how|hsbc|htc|hughes|hyatt|hyundai|ibm|icbc|ice|icu|ieee|ifm|iinet|ikano|imamat|imdb|immo|immobilien|industries|infiniti|ing|ink|institute|insurance|insure|intel|international|intuit|investments|ipiranga|irish|iselect|ismaili|ist|istanbul|itau|itv|iveco|iwc|jaguar|java|jcb|jcp|jeep|jetzt|jewelry|jio|jlc|jll|jmp|jnj|joburg|jot|joy|jpmorgan|jprs|juegos|juniper|kaufen|kddi|kerryhotels|kerrylogistics|kerryproperties|kfh|kia|kim|kinder|kindle|kitchen|kiwi|koeln|komatsu|kosher|kpmg|kpn|krd|kred|kuokgroup|kyknet|kyoto|lacaixa|ladbrokes|lamborghini|lamer|lancaster|lancia|lancome|land|landrover|lanxess|lasalle|lat|latino|latrobe|law|lawyer|lds|lease|leclerc|lefrak|legal|lego|lexus|lgbt|liaison|lidl|life|lifeinsurance|lifestyle|lighting|like|lilly|limited|limo|lincoln|linde|link|lipsy|live|living|lixil|loan|loans|locker|locus|loft|lol|london|lotte|lotto|love|lpl|lplfinancial|ltd|ltda|lundbeck|lupin|luxe|luxury|macys|madrid|maif|maison|makeup|man|management|mango|market|marketing|markets|marriott|marshalls|maserati|mattel|mba|mcd|mcdonalds|mckinsey|med|media|meet|melbourne|meme|memorial|men|menu|meo|metlife|miami|microsoft|mini|mint|mit|mitsubishi|mlb|mls|mma|mnet|mobily|moda|moe|moi|mom|monash|money|monster|montblanc|mopar|mormon|mortgage|moscow|moto|motorcycles|mov|movie|movistar|msd|mtn|mtpc|mtr|multichoice|mutual|mutuelle|mzansimagic|nab|nadex|nagoya|naspers|nationwide|natura|navy|nba|nec|netbank|netflix|network|neustar|new|newholland|news|next|nextdirect|nexus|nfl|ngo|nhk|nico|nike|nikon|ninja|nissan|nissay|nokia|northwesternmutual|norton|now|nowruz|nowtv|nra|nrw|ntt|nyc|obi|observer|off|office|okinawa|olayan|olayangroup|oldnavy|ollo|omega|one|ong|onl|online|onyourside|ooo|open|oracle|orange|organic|orientexpress|origins|osaka|otsuka|ott|ovh|page|pamperedchef|panasonic|panerai|paris|pars|partners|parts|party|passagens|pay|payu|pccw|pet|pfizer|pharmacy|philips|photo|photography|photos|physio|piaget|pics|pictet|pictures|pid|pin|ping|pink|pioneer|pizza|place|play|playstation|plumbing|plus|pnc|pohl|poker|politie|porn|pramerica|praxi|press|prime|prod|productions|prof|progressive|promo|properties|property|protection|pru|prudential|pub|pwc|qpon|quebec|quest|qvc|racing|raid|read|realestate|realtor|realty|recipes|red|redstone|redumbrella|rehab|reise|reisen|reit|reliance|ren|rent|rentals|repair|report|republican|rest|restaurant|review|reviews|rexroth|rich|richardli|ricoh|rightathome|ril|rio|rip|rmit|rocher|rocks|rodeo|rogers|room|rsvp|ruhr|run|rwe|ryukyu|saarland|safe|safety|sakura|sale|salon|samsclub|samsung|sandvik|sandvikcoromant|sanofi|sap|sapo|sarl|sas|save|saxo|sbi|sbs|sca|scb|schaeffler|schmidt|scholarships|school|schule|schwarz|science|scjohnson|scor|scot|seat|secure|security|seek|select|sener|services|ses|seven|sew|sex|sexy|sfr|shangrila|sharp|shaw|shell|shia|shiksha|shoes|shopping|shouji|show|showtime|shriram|silk|sina|singles|site|ski|skin|sky|skype|sling|smart|smile|sncf|soccer|social|softbank|software|sohu|solar|solutions|song|sony|soy|space|spiegel|spot|spreadbetting|srl|srt|stada|staples|star|starhub|statebank|statefarm|statoil|stc|stcgroup|stockholm|storage|store|stream|studio|study|style|sucks|supersport|supplies|supply|support|surf|surgery|suzuki|swatch|swiftcover|swiss|sydney|symantec|systems|tab|taipei|talk|taobao|target|tatamotors|tatar|tattoo|tax|taxi|tci|tdk|team|tech|technology|telecity|telefonica|temasek|tennis|teva|thd|theater|theatre|theguardian|tiaa|tickets|tienda|tiffany|tips|tires|tirol|tjmaxx|tjx|tkmaxx|tmall|today|tokyo|tools|top|toray|toshiba|total|tours|town|toyota|toys|trade|trading|training|travelchannel|travelers|travelersinsurance|trust|trv|tube|tui|tunes|tushu|tvs|ubank|ubs|uconnect|unicom|university|uno|uol|ups|vacations|vana|vanguard|vegas|ventures|verisign|versicherung|vet|viajes|video|vig|viking|villas|vin|vip|virgin|visa|vision|vista|vistaprint|viva|vivo|vlaanderen|vodka|volkswagen|volvo|vote|voting|voto|voyage|vuelos|wales|walmart|walter|wang|wanggou|warman|watch|watches|weather|weatherchannel|webcam|weber|website|wed|wedding|weibo|weir|whoswho|wien|wiki|williamhill|win|windows|wine|winners|wme|wolterskluwer|woodside|work|works|world|wow|wtc|wtf|xbox|xerox|xfinity|xihuan|xin|कॉम|セール|佛山|慈善|集团|在线|大众汽车|点看|คอม|八卦|موقع|一号店|公益|公司|香格里拉|网站|移动|我爱你|москва|католик|онлайн|сайт|联通|קום|时尚|微博|淡马锡|ファッション|орг|नेट|ストア|삼성|商标|商店|商城|дети|ポイント|新闻|工行|家電|كوم|中文网|中信|娱乐|谷歌|電訊盈科|购物|クラウド|通販|网店|संगठन|餐厅|网络|ком|诺基亚|食品|飞利浦|手表|手机|ارامكو|العليان|اتصالات|بازار|موبايلي|ابوظبي|كاثوليك|همراه|닷컴|政府|شبكة|بيتك|عرب|机构|组织机构|健康|рус|珠宝|大拿|みんな|グーグル|世界|書籍|网址|닷넷|コム|天主教|游戏|vermögensberater|vermögensberatung|企业|信息|嘉里大酒店|嘉里|广东|政务|xperia|xyz|yachts|yahoo|yamaxun|yandex|yodobashi|yoga|yokohama|you|youtube|yun|zappos|zara|zero|zip|zippo|zone|zuerich".split("|"),defaults_tokens={html:!1,wiki:!1,markdown:!1,hashtags:!0,mentions:!0,emails:!0,links:{protocols:!0,www:!1,tlds:{}}},HTML_ENTITIES={nbsp:" ",quot:'"',gt:">",lt:"<",amp:"&",ndash:"–"};for(let e=0;e<TLDs.length;e++)defaults_tokens.links.tlds[TLDs[e]]=!0;let Token=function(e,t,s,o,n,r,i,a){this.source=e,this.st=t,this.length=s,this.index=o,this.firstUpper=n,this.allUpper=r,this.type=i,a&&(this.subType=a)};Token.prototype.toString=function(){return"_str"in this&&this._str.length==this.length?this._str:this._str=this.source.substr(this.st,this.length)},Token.prototype.indexOf=function(e){if(1==e.length){for(let t=0;t<this.length;t++)if(this.source[this.st+t]==e)return t;return-1}return this.toString().indexOf(e)},Token.prototype.toLowerCase=function(){return this.toString().toLocaleLowerCase()},Token.prototype.isCapitalized=function(){return this.firstUpper&&!this.allUpper},Token.prototype.en=function(){return this.st+this.length-1};let Tokens=function(e,t){if(!(this instanceof exports.Tokens))return new exports.Tokens(e,t);this.tokens=[],this.source="","string"==typeof e?(this.config=t?az_1.Az.extend(defaults_tokens,t):defaults_tokens,this.append(e)):this.config=e?az_1.Az.extend(defaults_tokens,e):defaults_tokens,this.index=-1};function alwaysTrue(){return!0}function getMatcher(e,t){if(!e)return alwaysTrue();if("function"==typeof e)return e;let s,o=e;if("length"in e){s=!t,o={};for(let t=0;t<e.length;t++)o[e[t]]=!0}else s=t,t=!1;return function(e,n,r){if(e.subType){let s=e.type+"."+e.subType;if(s in o)return o[s]!=t}return e.type in o?o[e.type]!=t:!s}}exports.Tokens=Tokens,exports.Tokens.WORD=new String("WORD"),exports.Tokens.NUMBER=new String("NUMBER"),exports.Tokens.OTHER=new String("OTHER"),exports.Tokens.DIGIT=new String("DIGIT"),exports.Tokens.CYRIL=new String("CYRIL"),exports.Tokens.LATIN=new String("LATIN"),exports.Tokens.MIXED=new String("MIXED"),exports.Tokens.PUNCT=new String("PUNCT"),exports.Tokens.SPACE=new String("SPACE"),exports.Tokens.MARKUP=new String("MARKUP"),exports.Tokens.NEWLINE=new String("NEWLINE"),exports.Tokens.EMAIL=new String("EMAIL"),exports.Tokens.LINK=new String("LINK"),exports.Tokens.HASHTAG=new String("HASHTAG"),exports.Tokens.MENTION=new String("MENTION"),exports.Tokens.TAG=new String("TAG"),exports.Tokens.CONTENT=new String("CONTENT"),exports.Tokens.SCRIPT=new String("SCRIPT"),exports.Tokens.STYLE=new String("STYLE"),exports.Tokens.COMMENT=new String("COMMENT"),exports.Tokens.CLOSING=new String("CLOSING"),exports.Tokens.TEMPLATE=new String("TEMPLATE"),exports.Tokens.RANGE=new String("RANGE"),exports.Tokens.ENTITY=new String("ENTITY"),exports.Tokens.prototype.append=function(e,t){(t=t?az_1.Az.extend(this.config,t):this.config).links&&!0===t.links.tlds&&(t.links.tlds=defaults_tokens.links.tlds);let s=this.source.length;this.source+=e;let o=this.source,n=this.tokens;for(let e=s;e<o.length;e++){let s=o[e],r=o.charCodeAt(e),i=!1,a=n.length-1,l=n[a],p=e;if(t.html&&";"==s)if(a>0&&l.type===exports.Tokens.WORD&&1==n[a-1].length&&"&"==o[n[a-1].st]){let e=l.toLowerCase();e in HTML_ENTITIES&&(s=HTML_ENTITIES[e],r=s.charCodeAt(0),a-=2,l=n[a],n.length=a+1)}else a>1&&(l.type===exports.Tokens.NUMBER||l.type===exports.Tokens.WORD&&"x"==o[l.st])&&1==n[a-1].length&&"#"==o[n[a-1].st]&&1==n[a-1].length&&"&"==o[n[a-1].st]&&(r="x"==o[l.st]?parseInt(l.toString().substr(1),16):parseInt(l.toString(),10),s=String.fromCharCode(r),a-=3,l=n[a],n.length=a+1);let c=exports.Tokens.OTHER,h=s.toLocaleLowerCase()!=s;r>=1024&&r<=1279&&(c=exports.Tokens.CYRIL),(r>=65&&r<=90||r>=97&&r<=122||r>=192&&r<=591)&&(c=exports.Tokens.LATIN),r>=48&&r<=57&&(c=exports.Tokens.DIGIT),(r<=32||r>=128&&r<=160)&&(c=exports.Tokens.SPACE),"‐-−‒–—―.…,:;?!¿¡()[]«»\"'’‘’“”/⁄".indexOf(s)>-1&&(c=exports.Tokens.PUNCT);let g=c,k=!1;c===exports.Tokens.CYRIL||c===exports.Tokens.LATIN?(g=exports.Tokens.WORD,k=c):c===exports.Tokens.DIGIT&&(g=exports.Tokens.NUMBER);let u=!l||"\n"==o[l.st+l.length-1];if(t.wiki&&(u&&":;*#~|".indexOf(s)>-1&&(g=exports.Tokens.MARKUP,k=exports.Tokens.NEWLINE),"={[|]}".indexOf(s)>-1&&(g=exports.Tokens.MARKUP)),t.markdown&&(u&&"=-#>+-".indexOf(s)>-1&&(g=exports.Tokens.MARKUP,k=exports.Tokens.NEWLINE),"[]*~_`\\".indexOf(s)>-1&&(g=exports.Tokens.MARKUP)),l)if(t.wiki&&"'"!=s&&1==l.length&&"'"==o[l.st]&&a>0&&n[a-1].type===exports.Tokens.WORD&&n[a-1].subType===exports.Tokens.LATIN&&(n[a-1].length+=l.length,a-=1,n.length=a+1,l=n[a]),t.links&&t.links.tlds&&(c===exports.Tokens.PUNCT||c===exports.Tokens.SPACE)&&n.length>2&&n[a-2].type===exports.Tokens.WORD&&1==n[a-1].length&&"."==o[n[a-1].st]&&n[a].type===exports.Tokens.WORD&&l.toString()in t.links.tlds){for(;a>=2&&n[a-2].type===exports.Tokens.WORD&&1==n[a-1].length&&("."==o[n[a-1].st]||"@"==o[n[a-1].st]||":"==o[n[a-1].st]);)a-=2,l=n[a],l.length+=n[a+1].length+n[a+2].length,l.allUpper=l.allUpper&&n[a+1].allUpper&&n[a+2].allUpper;t.emails&&l.indexOf("@")>-1&&-1==l.indexOf(":")?l.type=exports.Tokens.EMAIL:(l.type=exports.Tokens.LINK,"/"==s&&(i=!0)),n.length=a+1}else if(l.type===exports.Tokens.LINK)")"==s&&a>=1&&n[a-1].type===exports.Tokens.MARKUP&&1==n[a-1].length&&"("==o[n[a-1].st]?g=exports.Tokens.MARKUP:c!==exports.Tokens.SPACE&&","!=s&&"<"!=s&&(i=!0);else if(l.type===exports.Tokens.EMAIL)c!==exports.Tokens.CYRIL&&c!==exports.Tokens.LATIN&&"."!=s||(i=!0);else if(l.type===exports.Tokens.HASHTAG||l.type===exports.Tokens.MENTION)(c===exports.Tokens.CYRIL||c==exports.Tokens.LATIN||c==exports.Tokens.DIGIT||"_"==s||"@"==s&&-1==l.indexOf("@"))&&(i=!0);else if(l.type!==exports.Tokens.TAG||!l.quote&&">"==o[l.en()])if(l.type===exports.Tokens.CONTENT)i=!0,l.quote?s==l.quote&&"\\"!=o[l.en()]&&delete l.quote:'"'==s||"'"==s?l.quote=s:">"==s&&(l.length>=8&&"</script"==l.toString().substr(-8)?(l.length-=8,p-=8,i=!1,g=exports.Tokens.TAG,k=exports.Tokens.CLOSING):l.length>=7&&"</style"==l.toString().substr(-7)&&(l.length-=7,p-=7,i=!1,g=exports.Tokens.TAG,k=exports.Tokens.CLOSING));else if(l.type===exports.Tokens.TAG&&l.type!==exports.Tokens.CLOSING&&l.length>=8&&"script"==l.toLowerCase().substr(1,6))g=exports.Tokens.CONTENT,k=exports.Tokens.SCRIPT;else if(l.type===exports.Tokens.TAG&&l.type!==exports.Tokens.CLOSING&&l.length>=7&&"style"==l.toLowerCase().substr(1,5))g=exports.Tokens.CONTENT,k=exports.Tokens.STYLE;else if(!t.html||1!=l.length||"<"!=o[l.st]||c!==exports.Tokens.LATIN&&"!"!=s&&"/"!=s)if(l.type===exports.Tokens.CONTENT)i=!0;else if(l.type!==exports.Tokens.MARKUP||l.subType!=exports.Tokens.TEMPLATE||"}"==o[l.en()]&&"}"==o[l.en()-1]){if(l.type===exports.Tokens.MARKUP&&l.type===exports.Tokens.LINK&&")"!=o[l.en()])i=!0;else if(l.type===exports.Tokens.MARKUP&&"`"==o[l.st]&&l.subType===exports.Tokens.NEWLINE&&c===exports.Tokens.LATIN)i=!0;else if(c===exports.Tokens.CYRIL||c===exports.Tokens.LATIN)l.type===exports.Tokens.WORD?(i=!0,l.subType=l.subType==c?l.subType:exports.Tokens.MIXED):l.type===exports.Tokens.NUMBER?(i=!0,l.subType=l.subType&&l.subType!=c?exports.Tokens.MIXED:c):t.hashtags&&1==l.length&&"#"==o[l.st]?(i=!0,l.type=exports.Tokens.HASHTAG):!t.mentions||1!=l.length||"@"!=o[l.st]||0!=a&&n[a-1].type!==exports.Tokens.SPACE?c!==exports.Tokens.LATIN||1!=l.length||"'"!=o[l.st]&&"’"!=o[l.st]?1==l.length&&"-"==o[l.st]&&(i=!0,a>0&&n[a-1].type===exports.Tokens.NUMBER&&(l=n[a-1],l.length+=n[a].length,n.length-=1),l.type=exports.Tokens.WORD,l.subType=c):(i=!0,l.type=exports.Tokens.WORD,l.subType=exports.Tokens.LATIN):(i=!0,l.type=exports.Tokens.MENTION);else if(c===exports.Tokens.DIGIT)l.type===exports.Tokens.WORD?(i=!0,l.subType=exports.Tokens.MIXED):l.type===exports.Tokens.NUMBER?i=!0:1!=l.length||"+"!=o[l.st]&&"-"!=o[l.st]?1==l.length&&(","==o[l.st]||"."==o[l.st])&&n.length>1&&n[a-1].type===exports.Tokens.NUMBER&&(i=!0,l=n[a-1],l.length+=n[a].length,n.length-=1):(i=!0,a>0&&n[a-1].type===exports.Tokens.NUMBER&&(l=n[a-1],l.length+=n[a].length,l.subType=exports.Tokens.RANGE,n.length-=1),l.type=exports.Tokens.NUMBER);else if(c===exports.Tokens.SPACE)l.type===exports.Tokens.SPACE&&(i=!0);else if(l.type===exports.Tokens.MARKUP&&o[l.st]==s&&"=-~:*#`'>_".indexOf(s)>-1)i=!0;else if("."==s)t.links&&t.links.www&&3==l.length&&"www"==l.toLowerCase()&&(i=!0,l.type=exports.Tokens.LINK);else if(t.wiki&&"'"==s&&"'"==o[l.en()])l.length>1?(l.length--,p--,g=exports.Tokens.MARKUP):(i=!0,l.type=exports.Tokens.MARKUP);else if("-"==s||l.subType==exports.Tokens.LATIN&&("’"==s||"'"==s))l.type===exports.Tokens.WORD&&(i=!0);else if("/"==s)t.links&&t.links.protocols&&n.length>2&&n[a-2].type===exports.Tokens.WORD&&n[a-2].subType==exports.Tokens.LATIN&&1==n[a-1].length&&":"==o[n[a-1].st]&&1==n[a].length&&"/"==o[n[a].st]&&(i=!0,l=n[a-2],l.length+=n[a-1].length+n[a].length,l.allUpper=l.allUpper&&n[a-1].allUpper&&n[a].allUpper,l.type=exports.Tokens.LINK,n.length-=2);else if(t.html&&";"==s)a>0&&l.type===exports.Tokens.WORD&&1==n[a-1].length&&"&"==o[n[a-1].st]?(i=!0,l=n[a-1],l.length+=n[a].length,l.allUpper=l.allUpper&&n[a-1].allUpper,l.type=exports.Tokens.ENTITY,n.length-=1):a>1&&(l.type===exports.Tokens.WORD||l.type===exports.Tokens.NUMBER)&&1==n[a-1].length&&"#"==o[n[a-1].st]&&1==n[a-2].length&&"&"==o[n[a-2].st]&&(i=!0,l=n[a-2],l.length+=n[a-1].length+n[a].length,l.allUpper=l.allUpper&&n[a-1].allUpper&&n[a].allUpper,l.type=exports.Tokens.ENTITY,n.length-=2);else if(t.markdown&&"["==s&&1==l.length&&"!"==o[l.st])i=!0,l.type=exports.Tokens.MARKUP;else if(t.markdown&&"("==s&&1==l.length&&"]"==o[l.st])g=exports.Tokens.MARKUP,k=exports.Tokens.LINK;else if(t.wiki&&"{"==s&&1==l.length&&"{"==o[l.st])i=!0,l.type=exports.Tokens.MARKUP,l.subType=exports.Tokens.TEMPLATE;else if(t.wiki&&"["==s&&1==l.length&&"["==o[l.st])i=!0;else if(t.wiki&&"]"==s&&1==l.length&&"]"==o[l.st])i=!0;else if(t.wiki&&"|"==s&&!u){let e=-1;for(let t=a-1;t>=0;t--){if(2==n[t].length&&"["==o[n[t].st]&&"["==o[n[t].st+1]){e=t;break}if(1==n[t].length&&"|"==o[n[t].st]||n[t].indexOf("\n")>-1)break}if(e>-1){i=!0;for(let t=a-1;t>=e;t--)l=n[t],l.length+=n[t+1].length,l.allUpper=l.allUpper&&n[t+1].allUpper;a=e,n.length=a+1,l.subType=exports.Tokens.LINK}}}else i=!0;else i=!0,l.type=exports.Tokens.TAG,"!"==s?l.subType=exports.Tokens.COMMENT:"/"==s&&(l.subType=exports.Tokens.CLOSING);else i=!0,l.quote?s==l.quote&&"\\"!=o[l.en()]&&delete l.quote:'"'!=s&&"'"!=s||(l.quote=s);i?(l.length++,l.allUpper=l.allUpper&&h):(l=new Token(o,p,e+1-p,n.length,h,h,g,k),n.push(l))}return this},exports.Tokens.prototype.done=function(e,t){if(!e)return this.tokens;let s=getMatcher(e,t),o=[];for(let e=0;e<this.tokens.length;e++)s(this.tokens[e],e,this.tokens)&&o.push(this.tokens[e]);return o},exports.Tokens.prototype.get=function(e,t,s){if(e<0)return!1;if(!t)return this.tokens[e];let o=getMatcher(t,s),n=0;for(let t=0;t<this.tokens.length;t++)if(o(this.tokens[t],t,this.tokens)){if(n==e)return this.tokens[t];n++}return!1},exports.Tokens.prototype.count=function(e,t){if(!e)return this.tokens.length;let s=getMatcher(e,t),o=0;for(let e=0;e<this.tokens.length;e++)s(this.tokens[e],e,this.tokens)&&o++;return o},exports.Tokens.prototype.nextToken=function(e,t,s){let o=getMatcher(t,s),n=this.index;for(n++;n<this.tokens.length&&o(this.tokens[n],n,this.tokens);)n++;return n<this.tokens.length?(e&&(this.index=n),this.tokens[n]):null},exports.Tokens.prototype.punctAhead=function(){let e=this.nextToken(!1,["SPACE"],!0);return e&&"PUNCT"==e.type&&e},exports.Tokens.prototype.prevToken=function(e,t,s){let o=getMatcher(t,s),n=this.index;for(n--;n>=0&&o(this.tokens[n],n,this.tokens);)n--;return n>=0?(e&&(this.index=n),this.tokens[n]):null},exports.Tokens.prototype.punctBehind=function(){let e=this.prevToken(!1,["SPACE"],!0);return e&&"PUNCT"==e.type&&e},exports.Tokens.prototype.hasTokensAhead=function(e,t){return null!=this.nextToken(!1,e,t)},exports.Tokens.prototype.hasTokensBehind=function(e,t){return null!=this.prevToken(!1,e,t)};